- pipeline: "Build & Deploy to Production"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://devmode.fm/"
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: webpack build"
      type: "BUILD"
      working_directory: "/buddy/$PROJECT_SHORTNAME"
      docker_image_name: "nystudio107/webpack-dev-base"
      docker_image_tag: "latest"
      execute_commands:
        - "cd docker-config/webpack-dev-devmode"
        - "npm ci"
        - "npm run build"
      volume_mappings:
        - "/:/buddy/$PROJECT_SHORTNAME"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Execute: composer install"
      type: "BUILD"
      working_directory: "/buddy/$PROJECT_SHORTNAME"
      docker_image_name: "nystudio107/php-dev-base"
      docker_image_tag: "latest"
      execute_commands:
        - "cd cms"
        - "composer install --no-scripts --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs"
      setup_commands:
        - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
        - "apt-get update && apt-get install -y git zip"
        - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
        - "# php ext pdo_mysql"
        - "docker-php-ext-install pdo_pgsql pgsql"
      volume_mappings:
        - "/:/buddy/$PROJECT_SHORTNAME"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Upload build files"
      type: "SFTP"
      input_type: "BUILD_ARTIFACTS"
      local_path: "cms/"
      remote_path: "$REMOTE_PROJECT_ROOT/deploy-cache"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "PUBLIC_KEY"
    - action: "Atomic deploy"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PROJECT_ROOT"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "PUBLIC_KEY"
      commands:
        - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
        - "then"
        - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
        - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
        - "fi"
        - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
        - "then"
        - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
        - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
        - "fi"
        - "echo \"Creating: persistant directories\""
        - "mkdir -p storage"
        - "echo \"Symlinking: persistant directories\""
        - "ln -nfs $REMOTE_PROJECT_ROOT/storage $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION"
        - "ln -nfs $REMOTE_PROJECT_ROOT/transcoder $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION/web"
        - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
        - "rm -f current"
        - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
        - "echo \"Removing old releases\""
        - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
      trigger_condition: "ALWAYS"
      run_as_script: true
      shell: "BASH"
    - action: "Prep Craft CMS"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PROJECT_ROOT/current"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "PUBLIC_KEY"
      commands:
        - "# Copy our .env file into place"
        - "cp ../../.env ./.env"
        - "# Ensure the craft script is executable"
        - "chmod a+x craft"
        - "# Run pending migrations, sync project config, and clear caches"
        - "./craft migrate/all"
        - "./craft project-config/sync"
        - "./craft clear-caches/all"
      trigger_condition: "ALWAYS"
      run_as_script: true
      shell: "BASH"
    - action: "Send notification to nystudio107 channel"
      type: "SLACK"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by $BUDDY_EXECUTION_REVISION_COMMITTER_NAME ."
      blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
      channel: "CAYN15RD0"
      channel_name: "nystudio107"
      trigger_condition: "ALWAYS"
      integration_hash: "5ef0d26820cfeb531cb10738"
  variables:
    - key: "PROJECT_SHORTNAME"
      value: "devmode"
    - key: "PROJECT_URL"
      value: "https://devmode.fm"
    - key: "REMOTE_PROJECT_ROOT"
      value: "/home/forge/devmode.fm"
    - key: "REMOTE_SSH_HOST"
      value: "devmode.fm"
    - key: "REMOTE_SSH_USER"
      value: "forge"
